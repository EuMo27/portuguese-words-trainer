// PortugueseWordsTrainer.jsx
import { useState, useEffect } from "react";
import { motion } from "framer-motion";

export default function PortugueseWordsTrainer() {
  const [words, setWords] = useState([]);
  const [portuguese, setPortuguese] = useState("");
  const [russian, setRussian] = useState("");
  const [search, setSearch] = useState("");
  const [isDark, setIsDark] = useState(false);
  const [testMode, setTestMode] = useState(false);
  const [currentWord, setCurrentWord] = useState(null);
  const [answer, setAnswer] = useState("");
  const [feedback, setFeedback] = useState("");
  const [hintShown, setHintShown] = useState(false);
  const [showPortuguese, setShowPortuguese] = useState(true);

  useEffect(() => {
    const saved = localStorage.getItem("words");
    if (saved) setWords(JSON.parse(saved));

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  }, []);

  useEffect(() => {
    localStorage.setItem("words", JSON.stringify(words));
  }, [words]);

  useEffect(() => {
    document.documentElement.classList.toggle("dark", isDark);
  }, [isDark]);

  const addWord = () => {
    if (portuguese && russian) {
      const newWords = [...words, { portuguese, russian, errors: 0 }];
      setWords(newWords);
      setPortuguese("");
      setRussian("");
    }
  };

  const filteredWords = words.filter(
    (w) =>
      w.portuguese.toLowerCase().includes(search.toLowerCase()) ||
      w.russian.toLowerCase().includes(search.toLowerCase())
  );

  const startTest = () => {
    if (words.length === 0) return;
    const weightedWords = words.flatMap((w) => Array(w.errors + 1).fill(w));
    const next = weightedWords[Math.floor(Math.random() * weightedWords.length)];
    setCurrentWord(next);
    setAnswer("");
    setFeedback("");
    setHintShown(false);
  };

  const checkAnswer = () => {
    const correct = showPortuguese
      ? currentWord.russian.toLowerCase() === answer.toLowerCase()
      : currentWord.portuguese.toLowerCase() === answer.toLowerCase();

    const updatedWords = words.map((w) =>
      w.portuguese === currentWord.portuguese
        ? { ...w, errors: correct ? w.errors : w.errors + 1 }
        : w
    );
    setWords(updatedWords);
    setFeedback(correct ? "âœ… Correct!" : "âŒ Incorrect");
    setTimeout(startTest, 1500);
  };

  const speak = () => {
    const utter = new SpeechSynthesisUtterance(
      showPortuguese ? currentWord.portuguese : currentWord.russian
    );
    utter.lang = showPortuguese ? "pt-PT" : "ru-RU";
    speechSynthesis.speak(utter);
  };

  return (
    <motion.div
      className={`p-4 max-w-xl mx-auto min-h-screen transition-colors duration-500 ${isDark ? 'bg-gray-900 text-white' : 'bg-white text-black'}`}
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
    >
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-2xl font-bold">ğŸ‡µğŸ‡¹ Portuguese Words Trainer ğŸ‡·ğŸ‡º</h1>
        <label className="flex items-center space-x-2 cursor-pointer">
          <span>ğŸŒ</span>
          <input type="checkbox" checked={isDark} onChange={() => setIsDark(!isDark)} />
          <span>ğŸŒœ</span>
        </label>
      </div>

      {!testMode ? (
        <>
          <div className="flex gap-2 mb-2">
            <input
              className="border p-2 flex-1 rounded"
              placeholder="Portuguese"
              value={portuguese}
              onChange={(e) => setPortuguese(e.target.value)}
            />
            <input
              className="border p-2 flex-1 rounded"
              placeholder="Russian"
              value={russian}
              onChange={(e) => setRussian(e.target.value)}
            />
            <button className="bg-blue-500 text-white px-4 py-2 rounded" onClick={addWord}>Add</button>
          </div>

          <input
            className="mb-4 w-full border p-2 rounded"
            placeholder="Search..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />

          <div className="grid gap-2">
            {filteredWords.map((word, i) => (
              <motion.div
                key={i}
                className="flex justify-between border p-2 rounded shadow bg-gray-100 dark:bg-gray-800"
                whileHover={{ scale: 1.02 }}
              >
                <span>{word.portuguese}</span>
                <span>{word.russian}</span>
              </motion.div>
            ))}
          </div>

          <button
            className="mt-4 w-full bg-green-600 text-white px-4 py-2 rounded"
            onClick={() => { setTestMode(true); startTest(); }}
          >
            Start Test Mode
          </button>
        </>
      ) : (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.4 }}
          className="space-y-4"
        >
          <div className="text-lg">
            Translate this word:
            <div className="text-2xl font-bold mt-2">
              {currentWord && (showPortuguese ? currentWord.portuguese : currentWord.russian)}
            </div>
          </div>

          <input
            className="border p-2 w-full rounded"
            placeholder="Type the translation..."
            value={answer}
            onChange={(e) => setAnswer(e.target.value)}
          />

          <div className="flex gap-2 flex-wrap">
            <button className="bg-blue-500 text-white px-4 py-2 rounded" onClick={checkAnswer}>Check</button>
            <button className="bg-yellow-400 px-4 py-2 rounded" onClick={() => setHintShown(true)}>Hint</button>
            <button className="bg-purple-500 text-white px-4 py-2 rounded" onClick={speak}>ğŸ”Š Speak</button>
            <button className="bg-red-500 text-white px-4 py-2 rounded" onClick={() => setTestMode(false)}>Exit</button>
          </div>

          {hintShown && currentWord && (
            <div>Hint: {showPortuguese ? currentWord.russian[0] : currentWord.portuguese[0]}</div>
          )}

          {feedback && (
            <motion.div
              className="text-xl font-semibold"
              initial={{ scale: 0.8 }}
              animate={{ scale: 1 }}
            >
              {feedback}
            </motion.div>
          )}

          <div className="flex items-center gap-2">
            <span>ğŸ‡µğŸ‡¹â†’ğŸ‡·ğŸ‡º</span>
            <input type="checkbox" checked={showPortuguese} onChange={() => setShowPortuguese(!showPortuguese)} />
            <span>ğŸ‡·ğŸ‡ºâ†’ğŸ‡µğŸ‡¹</span>
          </div>
        </motion.div>
      )}
    </motion.div>
  );
}
