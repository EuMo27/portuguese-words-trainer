import { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Switch } from "@/components/ui/switch";
import { motion } from "framer-motion";

export default function PortugueseWordsTrainer() {
  const [words, setWords] = useState([]);
  const [portuguese, setPortuguese] = useState("");
  const [russian, setRussian] = useState("");
  const [search, setSearch] = useState("");
  const [isDark, setIsDark] = useState(false);
  const [testMode, setTestMode] = useState(false);
  const [currentWord, setCurrentWord] = useState(null);
  const [answer, setAnswer] = useState("");
  const [feedback, setFeedback] = useState("");
  const [hintShown, setHintShown] = useState(false);
  const [showPortuguese, setShowPortuguese] = useState(true);

  useEffect(() => {
    const saved = localStorage.getItem("words");
    if (saved) setWords(JSON.parse(saved));
  }, []);

  useEffect(() => {
    localStorage.setItem("words", JSON.stringify(words));
  }, [words]);

  useEffect(() => {
    document.documentElement.classList.toggle("dark", isDark);
  }, [isDark]);

  const addWord = () => {
    if (portuguese && russian) {
      const newWords = [...words, { portuguese, russian, errors: 0 }];
      setWords(newWords);
      setPortuguese("");
      setRussian("");
    }
  };

  const filteredWords = words.filter(
    (w) =>
      w.portuguese.toLowerCase().includes(search.toLowerCase()) ||
      w.russian.toLowerCase().includes(search.toLowerCase())
  );

  const startTest = () => {
    if (words.length === 0) return;
    const weightedWords = words.flatMap((w) => Array(w.errors + 1).fill(w));
    const next = weightedWords[Math.floor(Math.random() * weightedWords.length)];
    setCurrentWord(next);
    setAnswer("");
    setFeedback("");
    setHintShown(false);
  };

  const checkAnswer = () => {
    const correct = showPortuguese
      ? currentWord.russian.toLowerCase() === answer.toLowerCase()
      : currentWord.portuguese.toLowerCase() === answer.toLowerCase();

    const updatedWords = words.map((w) =>
      w.portuguese === currentWord.portuguese
        ? { ...w, errors: correct ? w.errors : w.errors + 1 }
        : w
    );
    setWords(updatedWords);
    setFeedback(correct ? "Correct! ðŸŽ‰" : "Incorrect ðŸ˜¢");
    setTimeout(startTest, 1500);
  };

  const speak = () => {
    const utter = new SpeechSynthesisUtterance(
      showPortuguese ? currentWord.portuguese : currentWord.russian
    );
    utter.lang = showPortuguese ? "pt-PT" : "ru-RU";
    speechSynthesis.speak(utter);
  };

  return (
    <div className="p-4 max-w-xl mx-auto">
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-2xl font-bold">Portuguese Words Trainer</h1>
        <div className="flex items-center space-x-2">
          <span>ðŸŒž</span>
          <Switch checked={isDark} onCheckedChange={setIsDark} />
          <span>ðŸŒœ</span>
        </div>
      </div>

      {!testMode ? (
        <>
          <div className="flex gap-2 mb-2">
            <Input
              placeholder="Portuguese"
              value={portuguese}
              onChange={(e) => setPortuguese(e.target.value)}
            />
            <Input
              placeholder="Russian"
              value={russian}
              onChange={(e) => setRussian(e.target.value)}
            />
            <Button onClick={addWord}>Add</Button>
          </div>
          <Input
            className="mb-4"
            placeholder="Search..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />

          <div className="grid gap-2">
            {filteredWords.map((word, i) => (
              <Card key={i} className="bg-muted dark:bg-gray-800">
                <CardContent className="flex justify-between p-2">
                  <div>{word.portuguese}</div>
                  <div>{word.russian}</div>
                </CardContent>
              </Card>
            ))}
          </div>
          <Button className="mt-4 w-full" onClick={() => {setTestMode(true); startTest();}}>
            Start Test Mode
          </Button>
        </>
      ) : (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.4 }}
          className="space-y-4"
        >
          <div className="text-lg">
            Translate this word:
            <span className="block text-2xl font-bold mt-2">
              {currentWord && (showPortuguese ? currentWord.portuguese : currentWord.russian)}
            </span>
          </div>
          <Input
            placeholder="Type the translation..."
            value={answer}
            onChange={(e) => setAnswer(e.target.value)}
          />
          <div className="flex gap-2">
            <Button onClick={checkAnswer}>Check</Button>
            <Button variant="outline" onClick={() => setHintShown(true)}>Hint</Button>
            <Button variant="ghost" onClick={speak}>ðŸ”Š Speak</Button>
            <Button variant="destructive" onClick={() => setTestMode(false)}>Exit</Button>
          </div>
          {hintShown && currentWord && (
            <div>Hint: {showPortuguese ? currentWord.russian[0] : currentWord.portuguese[0]}</div>
          )}
          {feedback && (
            <motion.div
              className="text-xl font-semibold"
              initial={{ scale: 0.8 }}
              animate={{ scale: 1 }}
            >
              {feedback}
            </motion.div>
          )}
          <div className="flex items-center gap-2">
            <span>ðŸ‡µðŸ‡¹â†’ðŸ‡·ðŸ‡º</span>
            <Switch checked={showPortuguese} onCheckedChange={setShowPortuguese} />
            <span>ðŸ‡·ðŸ‡ºâ†’ðŸ‡µðŸ‡¹</span>
          </div>
        </motion.div>
      )}
    </div>
  );
}
